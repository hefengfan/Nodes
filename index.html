<!DOCTYPE html>
<html>

<head>
    <title>My V2Ray Resources</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #e0f2f7;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 10px;
        }

        .node-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative;
        }

        .node-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .copy-button:hover {
            background-color: #3e8e41;
        }

        .update-button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .update-button:hover {
            background-color: #0056b3;
        }

        #notification {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            min-width: 300px;
            max-width: 90%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #notification.success {
            background-color: rgba(173, 216, 230, 0.8);
            color: #333;
        }

        #notification.error {
            background-color: rgba(240, 128, 128, 0.8);
        }

        .node-count {
            font-size: 0.8em;
            color: #777;
            margin-left: 10px;
        }

        /* 新增 CSS 样式 */
        .node-list {
            overflow-x: auto;
            /* 启用水平滚动 */
            white-space: nowrap;
            /* 强制所有节点在一行显示 */
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .node-item {
            display: block;
            /* 每个节点占据一行 */
            font-family: monospace;
            font-size: 0.9em;
            padding: 2px 5px;
            border-bottom: 1px solid #eee;
            /* 可选：添加分隔线 */
            word-break: break-all;
            /* 允许长 URL 换行 */
        }

        .node-item:last-child {
            border-bottom: none;
            /* 移除最后一个节点的分隔线 */
        }

        /* 新增样式，用于显示文件信息 */
        .file-info {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
            /* 调整间距 */
        }

        /* 用户信息样式 */
        .user-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .network-speed {
            display: inline-block;
            margin-left: 15px;
        }

        .ip-info {
            display: inline-block;
        }

        /* v2rayNG 下载样式 */
        .v2rayng-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .v2rayng-badge {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .v2rayng-download-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }

        .v2rayng-download-button:hover {
            background-color: #3e8e41;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <h1>My V2Ray Resources</h1>
        <div class="user-info">
            <span class="ip-info">IP: <span id="ip-address">Loading...</span> - <span id="location">Loading
                    location...</span></span>
            <span class="network-speed">Network Speed: <span id="network-speed">Testing...</span></span>
        </div>
        <p>All collections by hefengfan.</p>

        <!-- v2rayNG 下载区域 -->
        <div class="v2rayng-container">
            <h2>下载最新 v2rayNG</h2>
            <div id="v2rayng-content">
                <p>正在从 GitHub 获取信息...</p>
            </div>
        </div>

        <button class="update-button" onclick="updateAllFiles()">Update All Files</button>

        <div id="clashmeta" class="node-container">
            <div class="node-title">clashmeta.txt <span class="node-count" id="clashmeta-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('clashmeta-content', 'clashmeta.txt')">Copy</button>
            <div class="file-info" id="clashmeta-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="clashmeta-content"></div>
        </div>

        <div id="ndnode" class="node-container">
            <div class="node-title">ndnode.txt <span class="node-count" id="ndnode-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('ndnode-content', 'ndnode.txt')">Copy</button>
            <div class="file-info" id="ndnode-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="ndnode-content"></div>
        </div>

        <div id="nodefree" class="node-container">
            <div class="node-title">nodefree.txt <span class="node-count" id="nodefree-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('nodefree-content', 'nodefree.txt')">Copy</button>
            <div class="file-info" id="nodefree-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="nodefree-content"></div>
        </div>

        <div id="nodev2ray" class="node-container">
            <div class="node-title">nodev2ray.txt <span class="node-count" id="nodev2ray-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('nodev2ray-content', 'nodev2ray.txt')">Copy</button>
            <div class="file-info" id="nodev2ray-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="nodev2ray-content"></div>
        </div>

        <div id="v2rayshare" class="node-container">
            <div class="node-title">v2rayshare.txt <span class="node-count" id="v2rayshare-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('v2rayshare-content', 'v2rayshare.txt')">Copy</button>
            <div class="file-info" id="v2rayshare-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="v2rayshare-content"></div>
        </div>

        <div id="wenode" class="node-container">
            <div class="node-title">wenode.txt <span class="node-count" id="wenode-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('wenode-content', 'wenode.txt')">Copy</button>
            <div class="file-info" id="wenode-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="wenode-content"></div>
        </div>

        <div id="yudou66" class="node-container">
            <div class="node-title">yudou66.txt <span class="node-count" id="yudou66-count"></span></div>
            <button class="copy-button" onclick="copyToClipboard('yudou66-content', 'yudou66.txt')">Copy</button>
            <div class="file-info" id="yudou66-info"></div>
            <!-- 文件信息显示区域，移动到内容上方 -->
            <div id="yudou66-content"></div>
        </div>
    </div>

    <div id="notification"></div>

    <script>
        // 正则表达式，用于判断是否为有效的 V2Ray/SS 节点
        const v2rayRegex = /^(vless|vmess|trojan|ss):\/\/.+$/;

        async function loadFileContent(filename, elementId, countElementId, infoElementId) {
            try {
                let response;
                let fileUrl;
                if (filename === 'xiaoji235/airport-free/v2ray.txt') {
                    fileUrl = 'https://gh.b52m.cn/https://github.com/xiaoji235/airport-free/blob/main/v2ray.txt?_=' + new Date().getTime();
                    response = await fetch(fileUrl);
                } else {
                    fileUrl = 'nodes/' + filename + '?_=' + new Date().getTime();
                    response = await fetch(fileUrl);
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const text = await response.text();
                // 去除重复行
                const lines = text.split('\n').map(line => line.trim());

                // 过滤掉不符合 V2Ray/SS 节点格式的行
                let validNodes = lines.filter(line => v2rayRegex.test(line));

                const uniqueNodes = [...new Set(validNodes)]; // 使用 Set 去重

                const fileSizeInBytes = new TextEncoder().encode(uniqueNodes.join('\n')).length;
                const fileSizeInKB = (fileSizeInBytes / 1024).toFixed(2);
                const lineCount = uniqueNodes.length;

                const container = document.getElementById(elementId);
                const nodeListContainer = document.getElementById(elementId);
                nodeListContainer.innerHTML = ''; // Clear previous content

                // 创建 node-list 容器
                const nodeList = document.createElement('div');
                nodeList.className = 'node-list';
                nodeListContainer.appendChild(nodeList);

                uniqueNodes.forEach((node) => {
                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.textContent = node;
                    nodeList.appendChild(nodeItem);
                });

                // 更新节点数量
                document.getElementById(countElementId).textContent = `(${uniqueNodes.length} nodes)`;

                // 显示文件信息
                document.getElementById(infoElementId).textContent = `Size: ${fileSizeInKB} KB, Lines: ${lineCount}`;


            } catch (error) {
                document.getElementById(elementId).textContent = 'Error loading file: ' + error;
                console.error('Error loading file:', error);
                document.getElementById(countElementId).textContent = '(Error)';
                document.getElementById(infoElementId).textContent = 'Error loading file info.';
            }
        }


        function copyToClipboard(elementId, filename) {
            const container = document.getElementById(elementId);
            const nodeItems = container.querySelectorAll('.node-item');
            let textToCopy = '';
            nodeItems.forEach(nodeItem => {
                textToCopy += nodeItem.textContent + '\n';
            });

            // 使用 navigator.clipboard API (如果可用)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        showNotification(`Content of ${filename} copied to clipboard!`, 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy using clipboard API: ', err);
                        fallbackCopyToClipboard(textToCopy, filename); // 使用备用方法
                    });
            } else {
                // 使用备用方法
                fallbackCopyToClipboard(textToCopy, filename);
            }
        }

        // 备用复制方法 (兼容性更好)
        function fallbackCopyToClipboard(text, filename) {
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = text;
            tempTextArea.style.position = "fixed"; // 防止页面滚动
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    throw new Error('Failed to copy using execCommand');
                }
                showNotification(`Content of ${filename} copied to clipboard!`, 'success');
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
                showNotification(`Failed to copy content of ${filename} to clipboard. Please try manually.  (Browser may not support automatic copying.)`, 'error');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }


        function showNotification(message, type = 'success') {
            const notificationElement = document.getElementById('notification');
            notificationElement.textContent = message;
            notificationElement.className = 'notification ' + type;
            notificationElement.style.display = 'block';
            setTimeout(() => {
                notificationElement.style.display = 'none';
            }, 3000);
        }

        function updateAllFiles() {
            loadFileContent('clashmeta.txt', 'clashmeta-content', 'clashmeta-count', 'clashmeta-info');
            loadFileContent('ndnode.txt', 'ndnode-content', 'ndnode-count', 'ndnode-info');
            loadFileContent('nodefree.txt', 'nodefree-content', 'nodefree-count', 'nodefree-info');
            loadFileContent('nodev2ray.txt', 'nodev2ray-content', 'nodev2ray-count', 'nodev2ray-info');
            loadFileContent('v2rayshare.txt', 'v2rayshare-content', 'v2rayshare-count', 'v2rayshare-info');
            loadFileContent('wenode.txt', 'wenode-content', 'wenode-count', 'wenode-info');
            loadFileContent('yudou66.txt', 'yudou66-content', 'yudou66-count', 'yudou66-info');
            showNotification('All files updated!', 'success');
        }

        // 获取用户IP和位置信息
        async function getUserIPAndLocation() {
            try {
                // 使用ipapi.co获取IP和位置信息
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();

                document.getElementById('ip-address').textContent = data.ip || 'Unknown';

                let locationText = '';
                if (data.city) locationText += data.city + ', ';
                if (data.region) locationText += data.region + ', ';
                if (data.country_name) locationText += data.country_name;

                document.getElementById('location').textContent = locationText || 'Unknown location';

            } catch (error) {
                console.error('Error fetching IP info:', error);
                document.getElementById('ip-address').textContent = 'Error loading IP';
                document.getElementById('location').textContent = 'Error loading location';
            } finally {
                // 每10秒重新获取一次IP和位置
                setTimeout(getUserIPAndLocation, 10000); // 10000毫秒 = 10秒
            }
        }

        // 测试网络速度
        function testNetworkSpeed() {
            const speedElement = document.getElementById('network-speed');
            let startTime, endTime;
            const fileSize = 500000; // 500KB测试文件

            // 使用一个虚拟URL进行测试
            const testUrl = 'https://httpbin.org/bytes/' + fileSize + '?_=' + new Date().getTime(); // 添加时间戳防止缓存

            startTime = performance.now();

            fetch(testUrl, {
                    cache: 'no-store'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.blob();
                })
                .then(() => {
                    endTime = performance.now();
                    const duration = (endTime - startTime) / 1000; // 转换为秒
                    const bitsLoaded = fileSize * 8;
                    const speedBps = bitsLoaded / duration;
                    const speedKbps = (speedBps / 1024).toFixed(2);
                    const speedMbps = (speedKbps / 1024).toFixed(2);

                    if (speedMbps > 1) {
                        speedElement.textContent = speedMbps + ' Mbps';
                    } else {
                        speedElement.textContent = speedKbps + ' Kbps';
                    }

                })
                .catch(error => {
                    console.error('Error testing network speed:', error);
                    speedElement.textContent = 'Error testing speed';
                })
                .finally(() => {
                    // 每10秒重新测试一次速度
                    setTimeout(testNetworkSpeed, 10000); // 10000毫秒 = 10秒
                });
        }

        // 获取 v2rayNG 信息
        async function fetchV2rayNGRelease() {
            try {
                const response = await fetch('https://api.github.com/repos/2dust/v2rayNG/releases/latest');
                if (!response.ok) {
                    throw new Error('无法从 GitHub 获取 v2rayNG 信息');
                }
                const release = await response.json();
                const universalAsset = release.assets.find(asset => asset.name.includes('universal.apk'));

                if (!universalAsset) {
                    throw new Error('未找到 v2rayNG universal.apk 文件');
                }

                const downloadUrl = universalAsset.browser_download_url;
                document.getElementById('v2rayng-content').innerHTML = `
                    <p><span class="v2rayng-badge">最新版本：${release.tag_name}</span></p>
                    <a href="${downloadUrl}" class="v2rayng-download-button">
                        <i class="fas fa-download"></i>
                        立即下载
                    </a>
                `;
            } catch (error) {
                document.getElementById('v2rayng-content').innerHTML = `
                    <p>错误: ${error.message}</p>
                `;
            }
        }

        // Load files on initial page load
        updateAllFiles();
        // 首次加载和启动定时更新
        getUserIPAndLocation();
        testNetworkSpeed();
        // 获取 v2rayNG 信息
        fetchV2rayNGRelease();
    </script>
</body>

</html>
